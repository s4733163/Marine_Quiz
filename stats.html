<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>24SEAFARERS ACADEMY — Admin Dashboard</title>
  <style>
    :root {
      --bg:    #f0f2f8;
      --card:  #fff;
      --ink:   #111;
      --muted: #555;
      --line:  #e3e5ef;
      --pill:  #eef0ff;
      --ok:    #0a7a2f;
      --bad:   #b00020;
      --brand: #003366;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    /* ── Header ── */
    .header {
      background: linear-gradient(135deg, var(--brand) 0%, #0b4c8a 60%, #0e6aa8 100%);
      color: #fff;
      padding: 16px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .hbrand { display: flex; align-items: center; gap: 13px; }
    .hicon  { font-size: 26px; }
    .hbrand h1 { font-size: 17px; letter-spacing: .3px; }
    .hbrand p  { font-size: 12px; opacity: .85; margin-top: 2px; }
    .hadmin {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .hadmin span { opacity: .8; }
    .hadmin button {
      background: rgba(255,255,255,.18);
      border: none;
      color: #fff;
      font-size: 12px;
      padding: 6px 13px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .hadmin button:hover { background: rgba(255,255,255,.28); }

    /* ── Layout ── */
    .wrap { max-width: 1060px; margin: 0 auto; padding: 28px 20px; }

    /* ── Card ── */
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,.07);
      padding: 26px;
    }

    /* ── Login ── */
    #loginView { max-width: 420px; margin: 60px auto; }
    #loginView h2 { font-size: 17px; margin-bottom: 20px; }
    .field { margin-bottom: 14px; }
    .field label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 5px; }
    .field input {
      width: 100%; padding: 10px 13px;
      border: 1px solid var(--line); border-radius: 11px;
      font-size: 14px; outline: none; background: #fff;
    }
    .field input:focus {
      border-color: #9bb8ff;
      box-shadow: 0 0 0 4px rgba(155,184,255,.2);
    }
    .btn {
      border: none; padding: 11px 22px; border-radius: 11px;
      cursor: pointer; font-weight: 700; font-size: 14px;
      background: #111; color: #fff;
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .hint { margin-top: 10px; font-size: 13px; color: var(--muted); min-height: 20px; }
    .hint.err { color: var(--bad); font-weight: 600; }

    /* ── Dashboard ── */
    #dashView { display: none; }
    #dashView.active { display: block; }

    /* Summary strip */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 14px;
      margin-bottom: 26px;
    }
    .sum-card {
      background: var(--card);
      border-radius: 14px;
      padding: 16px 18px;
      box-shadow: 0 2px 12px rgba(0,0,0,.06);
    }
    .sum-card .val {
      font-size: 28px;
      font-weight: 900;
      color: var(--brand);
      display: block;
      line-height: 1.1;
    }
    .sum-card .lbl { font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Filter bar */
    .filter-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .filter-bar input, .filter-bar select {
      padding: 8px 13px;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: 13px;
      outline: none;
      background: #fff;
    }
    .filter-bar input { flex: 1; min-width: 160px; }
    .filter-bar input:focus, .filter-bar select:focus {
      border-color: #9bb8ff;
    }
    .filter-bar .count {
      font-size: 13px;
      color: var(--muted);
      margin-left: auto;
      white-space: nowrap;
    }

    /* User accordion */
    .user-block {
      border: 1px solid var(--line);
      border-radius: 14px;
      margin-bottom: 12px;
      overflow: hidden;
      background: var(--card);
    }
    .user-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 18px;
      cursor: pointer;
      user-select: none;
      flex-wrap: wrap;
      background: #f5f7ff;
    }
    .user-head:hover { background: #eceeff; }
    .user-name  { font-weight: 800; font-size: 14px; color: var(--brand); }
    .user-email { font-size: 12px; color: var(--muted); }
    .user-meta  { margin-left: auto; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .badge {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 999px;
      background: var(--pill);
      color: var(--brand);
    }
    .chevron { font-size: 11px; color: var(--muted); transition: transform .2s; flex-shrink: 0; }
    .user-block.open .chevron { transform: rotate(180deg); }

    .user-body { display: none; padding: 0 16px 14px; }
    .user-block.open .user-body { display: block; }

    /* Attempt rows inside user */
    .attempt-row {
      border: 1px solid var(--line);
      border-radius: 11px;
      margin-top: 10px;
      overflow: hidden;
    }
    .attempt-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #fafbff;
      cursor: pointer;
      flex-wrap: wrap;
    }
    .attempt-head:hover { background: #f0f2ff; }
    .att-rank  { font-weight: 700; font-size: 13px; color: var(--brand); }
    .att-date  { font-size: 12px; color: var(--muted); }
    .att-score { margin-left: auto; font-size: 13px; font-weight: 600; }
    .pass-badge {
      font-size: 11px; font-weight: 800;
      padding: 2px 9px; border-radius: 999px;
    }
    .pass-badge.pass { background: rgba(10,122,47,.12); color: var(--ok); }
    .pass-badge.fail { background: rgba(176,0,32,.10);  color: var(--bad); }
    .att-chevron { font-size: 11px; color: var(--muted); transition: transform .2s; }
    .attempt-row.open .att-chevron { transform: rotate(180deg); }

    .attempt-body { display: none; padding: 8px 14px 12px; }
    .attempt-row.open .attempt-body { display: block; }

    /* Section table */
    .sec-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 6px; }
    .sec-table th {
      background: #f5f6ff; border: 1px solid #eee;
      padding: 6px 10px; text-align: left;
      font-size: 11px; color: var(--muted);
      text-transform: uppercase; letter-spacing: .4px;
    }
    .sec-table td { border: 1px solid #eee; padding: 7px 10px; }
    .bar-wrap {
      display: inline-block; width: 72px; height: 5px;
      background: #dde0ee; border-radius: 999px;
      vertical-align: middle; overflow: hidden; margin-right: 5px;
    }
    .bar-fill {
      height: 100%; border-radius: 999px;
      background: linear-gradient(90deg,#0b4c8a,#1bb3a7);
    }

    .empty { text-align: center; padding: 36px; color: var(--muted); font-size: 14px; }

    /* Spinner */
    .spinner {
      display: inline-block; width: 15px; height: 15px;
      border: 2px solid #ccc; border-top-color: var(--brand);
      border-radius: 50%; animation: spin .7s linear infinite;
      vertical-align: middle; margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- Header (always visible) -->
  <div class="header" id="pageHeader">
    <div class="hbrand">
      <div class="hicon">⚓</div>
      <div>
        <h1>24SEAFARERS ACADEMY</h1>
        <p>Admin Dashboard — All Users Statistics</p>
      </div>
    </div>
    <div class="hadmin" id="adminInfo" style="display:none;">
      <span id="adminLabel"></span>
      <button id="logoutBtn">Sign out</button>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <div id="loginView" class="card">
      <h2>Admin Login</h2>
      <div class="field">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" placeholder="admin@example.com" autocomplete="email" />
      </div>
      <div class="field">
        <label for="loginPassword">Password</label>
        <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <button class="btn" id="loginBtn">Login</button>
      <div class="hint" id="loginHint">Enter admin email and password.</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashView">

      <!-- Summary cards -->
      <div class="summary" id="summaryRow"></div>

      <!-- Filter bar -->
      <div class="filter-bar">
        <input id="searchInput" type="text" placeholder="Search by name or email…" />
        <select id="rankFilter"><option value="">All Ranks</option></select>
        <span class="count" id="userCount"></span>
      </div>

      <!-- User list -->
      <div id="userList"></div>
    </div>

  </div>

  <script>
    const BACKEND_URL = "http://127.0.0.1:5000";

    // DOM refs
    const loginView    = document.getElementById("loginView");
    const dashView     = document.getElementById("dashView");
    const loginEmail   = document.getElementById("loginEmail");
    const loginPassword= document.getElementById("loginPassword");
    const loginBtn     = document.getElementById("loginBtn");
    const loginHint    = document.getElementById("loginHint");
    const adminInfo    = document.getElementById("adminInfo");
    const adminLabel   = document.getElementById("adminLabel");
    const logoutBtn    = document.getElementById("logoutBtn");
    const summaryRow   = document.getElementById("summaryRow");
    const searchInput  = document.getElementById("searchInput");
    const rankFilter   = document.getElementById("rankFilter");
    const userCount    = document.getElementById("userCount");
    const userList     = document.getElementById("userList");

    let allUsers = [];   // full data from server

    // ── Helpers ────────────────────────────────────────────
    function esc(s) {
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }
    function fmtDate(iso) {
      if (!iso) return "—";
      try {
        return new Date(iso).toLocaleString(undefined, {
          day:"2-digit", month:"short", year:"numeric",
          hour:"2-digit", minute:"2-digit"
        });
      } catch { return iso; }
    }
    function setHint(msg, err) {
      loginHint.textContent = msg;
      loginHint.className = "hint" + (err ? " err" : "");
    }

    // ── Login ───────────────────────────────────────────────
    loginBtn.addEventListener("click", doLogin);
    [loginEmail, loginPassword].forEach(el =>
      el.addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); })
    );

    async function doLogin() {
      const email    = loginEmail.value.trim();
      const password = loginPassword.value.trim();

      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        setHint("Enter a valid email.", true); return;
      }
      if (!password) { setHint("Enter your password.", true); return; }

      loginBtn.disabled = true;
      loginHint.className = "hint";
      loginHint.innerHTML = '<span class="spinner"></span>Authenticating…';

      try {
        const resp = await fetch(`${BACKEND_URL}/get_stats`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        const data = await resp.json();

        if (data.ok) {
          showDashboard(data);
        } else {
          setHint(data.message || "Login failed.", true);
        }
      } catch {
        setHint("Cannot reach the server. Is the backend running?", true);
      } finally {
        loginBtn.disabled = false;
      }
    }

    // ── Logout ──────────────────────────────────────────────
    logoutBtn.addEventListener("click", () => {
      dashView.classList.remove("active");
      loginView.style.display = "";
      adminInfo.style.display = "none";
      loginPassword.value = "";
      allUsers = [];
      setHint("Enter admin email and password.", false);
    });

    // ── Dashboard ───────────────────────────────────────────
    function showDashboard(data) {
      allUsers = data.users || [];

      // Admin bar
      adminLabel.textContent = `${data.admin.username} (${data.admin.email})`;
      adminInfo.style.display = "flex";

      // Summary
      const totalUsers   = data.total_users   || 0;
      const totalAtt     = data.total_attempts || 0;
      const totalPasses  = data.total_passes   || 0;
      const passRate = totalAtt ? Math.round(totalPasses / totalAtt * 100) : 0;

      summaryRow.innerHTML = `
        <div class="sum-card"><span class="val">${totalUsers}</span><div class="lbl">Registered Users</div></div>
        <div class="sum-card"><span class="val">${totalAtt}</span><div class="lbl">Total Attempts</div></div>
        <div class="sum-card"><span class="val">${totalPasses}</span><div class="lbl">Total Passes</div></div>
        <div class="sum-card"><span class="val">${passRate}%</span><div class="lbl">Overall Pass Rate</div></div>
      `;

      // Populate rank filter
      const ranks = new Set();
      allUsers.forEach(u => u.attempts.forEach(a => ranks.add(a.rank)));
      rankFilter.innerHTML = '<option value="">All Ranks</option>';
      [...ranks].sort().forEach(r => {
        const o = document.createElement("option");
        o.value = r; o.textContent = r;
        rankFilter.appendChild(o);
      });

      // Show
      loginView.style.display = "none";
      dashView.classList.add("active");

      renderUsers();
    }

    // ── Filter + render ─────────────────────────────────────
    searchInput.addEventListener("input",  renderUsers);
    rankFilter.addEventListener("change",  renderUsers);

    function renderUsers() {
      const q    = searchInput.value.trim().toLowerCase();
      const rank = rankFilter.value;

      const filtered = allUsers.filter(u => {
        const nameMatch = !q ||
          u.username.toLowerCase().includes(q) ||
          u.email.toLowerCase().includes(q);
        const rankMatch = !rank ||
          u.attempts.some(a => a.rank === rank);
        return nameMatch && rankMatch;
      });

      userCount.textContent = `${filtered.length} user${filtered.length !== 1 ? "s" : ""}`;
      userList.innerHTML = "";

      if (!filtered.length) {
        userList.innerHTML = `<div class="empty">No users match the current filter.</div>`;
        return;
      }

      filtered.forEach(u => {
        const attempts = rank
          ? u.attempts.filter(a => a.rank === rank)
          : u.attempts;

        const totalAtt   = attempts.length;
        const passes     = attempts.filter(a => a.pass).length;
        const bestPct    = totalAtt ? Math.max(...attempts.map(a => a.pct)) : 0;

        const block = document.createElement("div");
        block.className = "user-block";

        block.innerHTML = `
          <div class="user-head">
            <span class="user-name">${esc(u.username)}</span>
            <span class="user-email">${esc(u.email)}</span>
            <div class="user-meta">
              <span class="badge">${totalAtt} attempt${totalAtt !== 1 ? "s" : ""}</span>
              <span class="badge">${passes} pass${passes !== 1 ? "es" : ""}</span>
              <span class="badge">Best: ${bestPct}%</span>
            </div>
            <span class="chevron">▼</span>
          </div>
          <div class="user-body" id="ub_${esc(u.email)}"></div>
        `;

        // Toggle
        block.querySelector(".user-head").addEventListener("click", () => {
          const wasOpen = block.classList.contains("open");
          block.classList.toggle("open");
          if (!wasOpen) renderAttempts(block.querySelector(".user-body"), attempts);
        });

        userList.appendChild(block);
      });
    }

    function renderAttempts(container, attempts) {
      if (container.dataset.rendered) return;
      container.dataset.rendered = "1";

      if (!attempts.length) {
        container.innerHTML = `<div class="empty" style="padding:18px">No attempts for this filter.</div>`;
        return;
      }

      attempts.forEach((a, i) => {
        const row = document.createElement("div");
        row.className = "attempt-row";

        const secRows = a.sections.map(s => `
          <tr>
            <td>${esc(s.name)}</td>
            <td>${s.correct} / ${s.total}</td>
            <td>
              <span class="bar-wrap"><span class="bar-fill" style="width:${s.pct}%"></span></span>
              ${s.pct}%
            </td>
          </tr>`).join("");

        row.innerHTML = `
          <div class="attempt-head">
            <span class="att-rank">${esc(a.rank)}</span>
            <span class="att-date">${fmtDate(a.attempted_at)}</span>
            <span class="att-score">${a.total_correct} / ${a.total_questions} correct &nbsp;(${a.pct}%)</span>
            <span class="pass-badge ${a.pass ? "pass" : "fail"}">${a.pass ? "PASS" : "FAIL"}</span>
            <span class="att-chevron">▼</span>
          </div>
          <div class="attempt-body">
            <table class="sec-table">
              <thead><tr><th>Section</th><th>Correct / Total</th><th>Score</th></tr></thead>
              <tbody>${secRows}</tbody>
            </table>
          </div>`;

        row.querySelector(".attempt-head").addEventListener("click", () =>
          row.classList.toggle("open")
        );

        // Auto-expand the latest attempt
        if (i === 0) row.classList.add("open");

        container.appendChild(row);
      });
    }
  </script>
</body>
</html>
